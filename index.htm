<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Akshat Prasad - Sitemap & URL Governance</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<meta name="google-site-verification" content="Kp1gscirNuecI5_9R4LDkE5ql4w4zt0NmneiPktuMu4" />
  <!-- Responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ===== AUTHOR & NETWORK AUTHORITY ===== -->
<meta name="author" content="Akshat Prasad">
<meta name="creator" content="Akshat Prasad">
<meta name="publisher" content="Akshat Prasad">

<link rel="canonical" href="https://akshat-881236.github.io/SitemapGeneratorXml/">
<link rel="index" href="https://akshat-881236.github.io/sitemapjs/">

<link rel="me" href="https://github.com/Akshat-881236">
<link rel="me" href="https://akshat-881236.github.io/sitemapjs/">

<meta name="robots" content="index, follow">
<!-- ===== AUTHOR & NETWORK AUTHORITY ===== -->
<meta name="author" content="Akshat Prasad">
<meta name="creator" content="Akshat Prasad">
<meta name="publisher" content="Akshat Prasad">

<link rel="canonical" href="https://akshat-881236.github.io/SitemapGeneratorXml/">
<link rel="index" href="https://akshat-881236.github.io/sitemapjs/">

<link rel="me" href="https://github.com/Akshat-881236">
<link rel="me" href="https://akshat-881236.github.io/sitemapjs/">
<link rel="me" href="mailto:akshatpsd2005@gmail.com">
<!-- Sitemap.xml Link-->
<link rel="sitemap" type="application/xml" title="Sitemap" href="https://akshat-881236.github.io/sitemapjs/sitemap.xml">
<meta name="robots" content="index, follow">
<script src="https://akshat-881236.github.io/sitemapjs/sitemap.min.js"></script>
  <!-- Theme -->
  <meta name="theme-color" content="#2563eb" />
  <script src="/SitemapGeneratorXml/seoLoader.js" defer></script>
  <noscript>
  <meta name="description"
        content="Frontend Sitemap Generator by Akshat Prasad">
  </noscript>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<style>
/* ===========================
   Global Styles & Theme Base
   Shared across platforms. Platform-specific HTML variations
   are controlled via body.platform-* classes and media queries.
   =========================== */
:root{
  --bg: #f6f7fb;
  --panel: #ffffff;
  --muted: #6b7280;
  --text: #0f172a;
  --accent: #2563eb;
  --success: #16a34a;
  --danger: #dc2626;
  --glass: rgba(15,23,42,0.04);
  --shadow: 0 6px 18px rgba(7,12,34,0.06);
  --radius: 10px;
  --max-width: 1200px;
  --header-height: 72px;
  --sidebar-width: 260px;
}
[data-theme="dark"]{
  --bg: #071024;
  --panel: #071226;
  --muted: #9aa6b2;
  --text: #e6eef6;
  --accent: #4f8cff;
  --success: #34d399;
  --danger: #ff7b7b;
  --glass: rgba(255,255,255,0.03);
  --shadow: 0 6px 18px rgba(0,0,0,0.6);
}
[data-theme="sepia"]{
  --bg: #fbf6f0;
  --panel: #fff9f3;
  --muted: #7a6246;
  --text: #2b1f15;
  --accent: #a3571a;
  --success: #2e7d32;
  --danger: #b00020;
  --glass: rgba(43,31,21,0.03);
  --shadow: 0 6px 18px rgba(43,31,21,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.app{
  max-width:var(--max-width);
  margin:12px auto;
  padding:12px;
  display:grid;
  grid-template-columns:var(--sidebar-width) 1fr 360px;
  gap:12px;
  align-items:start;
}
/* Header shared */
.header{
  grid-column:1/-1;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  height:var(--header-height);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#00c2ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:var(--shadow)
}
.h1{font-size:18px;font-weight:700}
.controls{display:flex;align-items:center;gap:8px}
.btn{
  background:var(--panel);
  border:1px solid rgba(0,0,0,0.04);
  padding:8px 12px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow);
  font-size:13px;
}
.btn.primary{background:linear-gradient(90deg,var(--accent),#00b4ff);color:white;border:0}
.btn.ghost{background:transparent;border:1px dashed rgba(0,0,0,0.06)}
.icon{font-size:16px;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.sidebar{
  background:var(--panel);
  border-radius:var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  height:calc(100vh - 120px);
  overflow:auto;
  width:var(--sidebar-width);
}
.sidebar.hidden{display:none !important}
.tabs{display:flex;flex-direction:column;gap:6px}
.tab{
  display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;color:var(--muted);user-select:none
}
.tab.active{background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);color:var(--text);font-weight:600}
.main{
  background:var(--panel);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  min-height:60vh;
  overflow:auto;
}
.right{
  background:var(--panel);
  border-radius:var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  height:calc(100vh - 120px);
  overflow:auto;
}
.section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.grid{display:grid;gap:12px}
.columns-2{grid-template-columns:1fr 1fr}
.row{display:flex;gap:8px;align-items:center}
.input,textarea,select{
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)
}
textarea{min-height:90px;resize:vertical}
.list{background:var(--glass);padding:8px;border-radius:8px}
.folder-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px}
.folder-item .meta{font-size:12px;color:var(--muted)}
.url-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.02);margin-bottom:8px}
.url-row .left{flex:1;display:flex;gap:10px;align-items:center}
.logo-thumb{width:44px;height:44;border-radius:6px;object-fit:cover;background:var(--glass);display:inline-block}
.badge{background:rgba(0,0,0,0.06);padding:6px 8px;border-radius:6px;font-size:12px}
.tag{background:rgba(37,99,235,0.08);color:var(--accent);padding:4px 8px;border-radius:6px;font-size:12px}
.toolbar{display:flex;gap:8px;align-items:center}
.footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

/* Toasts */
.toast-wrap{position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{padding:10px 12px;border-radius:8px;color:white;min-width:220px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.warn{background:#f59e0b}

/* XML preview */
.xml-preview{background:#0b1220;color:#dff1ff;padding:12px;border-radius:8px;font-family:monospace;font-size:13px;overflow:auto;max-height:360px;border:1px solid rgba(255,255,255,0.03)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:left;font-size:13px}
.input:focus,textarea:focus,select:focus,.btn:focus{outline:2px solid rgba(37,99,235,0.12)}

/* ===========================
   Swipe handle & gesture hint
   =========================== */
#swipeHandle{
  position:fixed;left:0;top:50%;transform:translateY(-50%);z-index:9998;
  width:18px;height:80px;border-radius:0 8px 8px 0;background:linear-gradient(180deg,rgba(0,0,0,0.06),transparent);display:none;align-items:center;justify-content:center;cursor:pointer;
}
#swipeHandle.visible{display:flex}

/* ===========================
   Platform-specific adjustments
   We will toggle body.platform-mobile or platform-desktop
   to adjust DOM or hide/show elements.
   =========================== */

/* Mobile compressed layout */
body.platform-mobile .app{grid-template-columns:1fr; padding:8px}
body.platform-mobile .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:9999;transform:translateX(0);transition:transform .25s ease;display:block}
body.platform-mobile .sidebar.hidden{transform:translateX(-110%);display:block}
body.platform-mobile .right{display:none}
body.platform-mobile .header{height:56px}
body.platform-mobile .logo{width:40px;height:40px}

/* Desktop tweaks */
@media (min-width:1100px){
  body.platform-desktop .sidebar{display:block}
  #swipeHandle{display:none !important}
}

/* iOS-specific subtle changes */
body.platform-ios .header{backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px)}
body.platform-android .btn{border-radius:10px}

/* Theme-specific micro adjustments */
[data-theme="dark"] .list{background:rgba(255,255,255,0.02)}
[data-theme="sepia"] .logo{background:linear-gradient(90deg,var(--accent),#ffd6a5);color:#fff}

/* responsive for right panel */
@media (max-width:1100px){
  .right{display:none}
  .app{grid-template-columns:1fr}
}

/* tiny helper */
.kbd{background:rgba(0,0,0,0.06);padding:2px 6px;border-radius:6px;font-size:12px}
.rule{height:1px;background:rgba(0,0,0,0.04);margin:10px 0}

/* ensure focus visible for accessibility */
:focus{outline-offset:2px}
</style>
</head>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Sitemap Generator",
  "applicationCategory": "DeveloperTool",
  "operatingSystem": "Web",
  "creator": {
    "@type": "Person",
    "name": "Akshat Prasad"
  }
}
</script>
<script src="https://akshat-881236.github.io/TrackerJS/MITLicense-Term-of-Use--Privacy.min.js"></script>
<script src="https://akshat-881236.github.io/sitemapjs/breadcrumb.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/redirect.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/akshatnetworkhub.min.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/tracker.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/trackermeta.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/ui.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/index.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/akshat-add-nav.js"></script>
<body onload="pushData()">
<div id="swipeHandle" aria-hidden="true"><i class="bi bi-chevron-right"></i></div>

<div class="app" id="app" role="application" aria-label="Sitemap Governance System">
  <div class="header" id="headerBar">
    <div class="brand" id="brandArea">
      <button class="btn" id="sidebarToggle" aria-label="Toggle sidebar"><i class="bi bi-list"></i></button>
      <div class="logo" aria-hidden="true">
        <img src="https://akshat-881236.github.io/SitemapGeneratorXml/Assets/icon-192.png" alt="Logo" style="width:32px;height:32px;border-radius:6px;object-fit:cover">
      </div>
      <div id="titleBlock"><div class="h1">Sitemap Governance</div><div class="small">Enterprise URL & Sitemap Manager — LocalStorage Powered</div></div>
    </div>
    <div class="controls" id="topControls">
      <div class="small" id="routeHint">Dashboard</div>
      <button class="btn" id="themeToggle" title="Theme"> <i class="bi bi-circle-half"></i> Theme</button>
      <button class="btn" id="helpBtn" title="Keyboard Shortcuts"><i class="bi bi-question-circle"></i></button>
      <button class="btn" id="loginBtn" title="Admin Login"><i class="bi bi-shield-lock"></i> <span id="loginLabel">Admin</span></button>
    </div>
  </div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar" aria-label="Main Navigation">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px"><div style="font-weight:700">Navigation</div><div class="small platformBadge" id="platformBadge"></div></div>
        <div class="small" id="dbVersionLabel">Schema v1</div>
      </div>
      <div class="tabs" id="navTabs" role="tablist" aria-orientation="vertical">
        <div class="tab active" data-route="dashboard" role="tab"><i class="bi bi-speedometer2 icon"></i> Dashboard</div>
        <div class="tab" data-route="folders" role="tab"><i class="bi bi-folder2 icon"></i> Folder / Project Manager</div>
        <div class="tab" data-route="urls" role="tab"><i class="bi bi-link-45deg icon"></i> URL Manager</div>
        <div class="tab" data-route="sitemap" role="tab"><i class="bi bi-file-earmark-code icon"></i> Sitemap Generator</div>
        <div class="tab" data-route="meta" role="tab"><i class="bi bi-meta icon"></i> SEO & Meta Manager</div>
        <div class="tab" data-route="auth" role="tab"><i class="bi bi-key-fill icon"></i> Authorization Panel</div>
        <div class="tab" data-route="dev" role="tab"><i class="bi bi-tools icon"></i> Developer Tools</div>
      </div>
      <div class="rule"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="importBtn" title="Import DB">Import</button>
        <button class="btn" id="exportBtn" title="Export DB">Export</button>
      </div>
      <div class="rule"></div>
      <div style="font-size:13px;color:var(--muted);">
        Tips:
        <ul style="padding-left:18px;margin:6px 0 0 0">
          <li>Swipe from left edge to open/close navigation (mobile)</li>
          <li>Ctrl+1..7 to switch tabs</li>
          <li>Ctrl+Z / Ctrl+Y Undo/Redo</li>
          <li>Admin-only destructive actions</li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="main" id="mainPanel" tabindex="0">
    <!-- Dynamically injected content -->
    <div id="view"></div>
  </main>

  <!-- Right panel -->
  <aside class="right" id="rightPanel">
    <div class="section-title"><strong>Quick Actions</strong><div class="small">Keyboard & Quick Links</div></div>
    <div class="grid">
      <div>
        <label class="small">Global Search</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="globalSearch" class="input" placeholder="Search URLs, titles, tags..." aria-label="Global search">
          <button class="btn" id="searchBtn"><i class="bi bi-search"></i></button>
        </div>
      </div>
      <div>
        <label class="small">Filters</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <select id="filterFolder" class="input" aria-label="Filter folder"><option value="">All Folders</option></select>
          <select id="filterType" class="input" aria-label="Filter network"><option value="">All</option><option value="internal">Internal</option><option value="external">External</option><option value="third-party">Third-party</option></select>
        </div>
      </div>
      <div>
        <label class="small">Theme</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <select id="themeSelect" class="input" aria-label="Theme select"><option value="auto">Auto</option><option value="light">Light</option><option value="dark">Dark</option><option value="sepia">Sepia</option></select>
        </div>
      </div>
      <div>
        <label class="small">System Health</label>
        <div class="list" id="healthPanel">
          <div id="healthContent" class="small">Loading...</div>
        </div>
      </div>
      <div>
        <label class="small">Undo / Redo</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" id="undoBtn" title="Undo (Ctrl+Z)"><i class="bi bi-arrow-counterclockwise"></i></button>
          <button class="btn" id="redoBtn" title="Redo (Ctrl+Y)"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
      </div>
    </div>
    <div class="rule"></div>

    <div>
      <label class="small">Selected URL Preview</label>
      <div id="previewPanel" class="list" style="margin-top:8px">
        <div class="small">No URL selected</div>
      </div>
    </div>
  </aside>

  <div class="footer">Sitemap Governance • LocalStorage | <span id="countsLabel">0 folders • 0 URLs</span></div>
</div>

<!-- Toast container -->
<div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

<!-- Hidden file input for import -->
<input type="file" id="importFile" accept="application/json" style="display:none" />

<script>
/*
  Enhanced Sitemap Governance System (single-file SPA)
  Updates:
  - Sidebar navigation toggleable via swipe gestures and click
  - Platform detection (mobile/desktop/iOS/Android) changes certain UI HTML pieces
  - Themes include light/dark/sepia and 'auto' detection; theme toggles persist
  - All advanced features from prior version persist (DB, sitemap, meta, auth, undo/redo)
  Single global namespace: window.SITEMAP_APP
*/

(function(window, document){
  'use strict';

  const SITEMAP_APP = (function(){

    /* =========================
       Configuration & Keys
       ========================= */
    const SCHEMA_VERSION = 1;
    const STORAGE_KEY = 'sg_db_v' + SCHEMA_VERSION;
    const AUTH_KEY = 'sg_auth';
    const THEME_KEY = 'sg_theme_pref';
    const MANUAL_SITEMAP_KEY = 'sg_manual_sitemap';
    const UI_STATE_KEY = 'sg_ui_state_v1';

    /* =========================
       Data Schema
       ========================= */
    const DEFAULT_DB = {
      meta: {
        title: 'My Sites Network',
        description: 'A curated network of GitHub Pages projects.',
        keywords: 'github,pages,sitemap,seo',
        author: '',
        robots: 'index,follow'
      },
      folders: [],
      schemaVersion: SCHEMA_VERSION,
      settings: {
        splitSitemapsPerFolder: false,
        autoUpdateLastmod: true
      },
      _lastGenerated: null
    };

    const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,10);

    function safeParseJSON(str, fallback=null){
      try{ return JSON.parse(str); } catch(e) { return fallback; }
    }

    function loadDB(){
      let raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        // attempt migration fallback keys
        const fallbackKeys = Object.keys(localStorage).filter(k=>k.startsWith('sg_db_'));
        if(fallbackKeys.length) raw = localStorage.getItem(fallbackKeys[0]);
      }
      const parsed = safeParseJSON(raw, null);
      if(!parsed || typeof parsed !== 'object' || parsed.schemaVersion !== SCHEMA_VERSION){
        const db = JSON.parse(JSON.stringify(DEFAULT_DB));
        saveDB(db);
        return db;
      }
      // defensive: ensure structure exists
      parsed.folders = Array.isArray(parsed.folders) ? parsed.folders : [];
      parsed.meta = parsed.meta || DEFAULT_DB.meta;
      parsed.settings = parsed.settings || DEFAULT_DB.settings;
      return parsed;
    }

    function saveDB(db){
      db.schemaVersion = SCHEMA_VERSION;
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); } catch(e){ console.error('saveDB failed', e); showToast('Failed to save DB','error'); }
    }

    /* =========================
       Authorization Flow
       - Hashing via SubtleCrypto
       - Session stored in sessionStorage
       ========================= */
    const AUTH = {
      async hashPass(pass, saltHex){
        const enc = new TextEncoder();
        const salt = saltHex ? hexToBytes(saltHex) : crypto.getRandomValues(new Uint8Array(16));
        const data = new Uint8Array(salt.length + enc.encode(pass).length);
        data.set(salt, 0);
        data.set(enc.encode(pass), salt.length);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return {hash: bytesToHex(new Uint8Array(digest)), salt: bytesToHex(salt)};
      },
      async setPass(pass){
        const {hash, salt} = await AUTH.hashPass(pass);
        localStorage.setItem(AUTH_KEY, JSON.stringify({hash, salt}));
        showToast('Admin passcode set','success');
      },
      isPassSet(){ return !!localStorage.getItem(AUTH_KEY); },
      async verify(pass){
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return false;
        const {hash, salt} = safeParseJSON(raw, {});
        const res = await AUTH.hashPass(pass, salt);
        return res.hash === hash;
      },
      loginSession(){ sessionStorage.setItem('sg_session','1'); },
      logoutSession(){ sessionStorage.removeItem('sg_session'); },
      isAdmin(){ return sessionStorage.getItem('sg_session') === '1'; },
      async ensureAdmin(promptMsg='Enter admin passcode:'){ if(AUTH.isAdmin()) return true; const pass = prompt(promptMsg); if(!pass) return false; const ok = await AUTH.verify(pass); if(ok){ AUTH.loginSession(); showToast('Admin access granted','success'); renderHeader(); return true; } else { showToast('Invalid passcode','error'); return false; } }
    };

    /* =========================
       Sitemap Engine
       ========================= */
    const SITEMAP = {
      xmlEscape(str){ if(str==null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); },
      normalizePriority(p){
        if(p==null||p==='') return '';
        let n = parseFloat(String(p).replace(',', '.'));
        if(isNaN(n)) n=0;
        n = Math.max(0, Math.min(1, n));
        return n.toFixed(1);
      },
      validChangefreq(val){
        const allowed = ['always','hourly','daily','weekly','monthly','yearly','never',''];
        return allowed.includes(String(val).toLowerCase());
      },
      validLoc(val){
        if(!val) return false;
        try{
          const s = String(val).trim();
          if(s.startsWith('/')) return true;
          const url = new URL(s);
          return url.protocol === 'http:' || url.protocol === 'https:';
        }catch(e){ return false; }
      },
      buildUrlEntry(u){
        const loc = SITEMAP.xmlEscape(u.loc);
        const lastmod = u.lastmod ? SITEMAP.xmlEscape(u.lastmod) : '';
        const changefreq = SITEMAP.validChangefreq(u.changefreq) ? SITEMAP.xmlEscape(u.changefreq) : '';
        const priority = SITEMAP.normalizePriority(u.priority);
        let out = '  <url>\n    <loc>' + loc + '</loc>\n';
        if(lastmod) out += '    <lastmod>' + lastmod + '</lastmod>\n';
        if(changefreq) out += '    <changefreq>' + changefreq + '</changefreq>\n';
        if(priority!=='') out += '    <priority>' + priority + '</priority>\n';
        out += '  </url>\n';
        return out;
      },
      buildSitemap(urls){
        const header = '<?xml version="1.0" encoding="UTF-8"?>\n' + '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
        const body = urls.map(u => SITEMAP.buildUrlEntry(u)).join('');
        const footer = '</urlset>';
        return header + body + footer;
      },
      buildSitemapIndex(sitemaps){
        const header = '<?xml version="1.0" encoding="UTF-8"?>\n' + '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
        const body = sitemaps.map(s => {
          let b = '  <sitemap>\n    <loc>' + SITEMAP.xmlEscape(s.loc) + '</loc>\n';
          if(s.lastmod) b += '    <lastmod>' + SITEMAP.xmlEscape(s.lastmod) + '</lastmod>\n';
          b += '  </sitemap>\n';
          return b;
        }).join('');
        const footer = '</sitemapindex>';
        return header + body + footer;
      },
      validateXMLString(xmlStr){
        try{
          const parser = new DOMParser();
          const doc = parser.parseFromString(xmlStr, 'application/xml');
          const err = doc.querySelector('parsererror');
          return {ok: !err, error: err ? err.textContent : null};
        }catch(e){
          return {ok:false,error:String(e)};
        }
      }
    };

    /* =========================
       Meta Manager
       ========================= */
    const META = {
      limits: { descriptionMin: 10, descriptionMax: 160, titleMax: 70 },
      setGlobal(db){ if(!db || !db.meta) return; applyMeta(db.meta); },
      applyFolderOverride(folder){ if(folder && folder.metaOverride) applyMeta(Object.assign({}, currentDB.meta, folder.metaOverride)); else applyMeta(currentDB.meta); }
    };

    function applyMeta(metaObj){
      if(!metaObj) return;
      if(metaObj.title) document.title = metaObj.title;
      const setMeta = (name, content, attrName='name') => {
        if(content==null) return;
        let el = document.head.querySelector('meta['+attrName+'="'+name+'"]');
        if(!el){ el = document.createElement('meta'); el.setAttribute(attrName, name); document.head.appendChild(el); }
        el.setAttribute('content', content);
      };
      setMeta('description', metaObj.description || '');
      setMeta('keywords', metaObj.keywords || '');
      setMeta('author', metaObj.author || '');
      setMeta('robots', metaObj.robots || '');
    }

    function validateMeta(db){
      const errors = [];
      const descs = new Map();
      db.folders.forEach(folder => {
        const m = folder.metaOverride;
        if(m && m.description){
          if(m.description.length < META.limits.descriptionMin) errors.push({folder:folder.name,issue:'Meta description too short'});
          if(m.description.length > META.limits.descriptionMax) errors.push({folder:folder.name,issue:'Meta description too long'});
          if(descs.has(m.description)) errors.push({folder:folder.name,issue:'Duplicate meta description with ' + descs.get(m.description)});
          descs.set(m.description, folder.name);
        }
      });
      if(db.meta){
        if(!db.meta.description || db.meta.description.trim()==='') errors.push({global:true,issue:'Global meta description empty'});
        else{
          if(db.meta.description.length < META.limits.descriptionMin) errors.push({global:true,issue:'Global meta description too short'});
          if(db.meta.description.length > META.limits.descriptionMax) errors.push({global:true,issue:'Global meta description too long'});
        }
      }
      return errors;
    }

    /* =========================
       App Core: state, undo/redo, DB ops
       ========================= */
    let currentDB = loadDB();
    let undoStack = [];
    let redoStack = [];
    const UNDO_LIMIT = 200;

    function pushUndo(action){
      undoStack.push({ts:Date.now(),action,db:deepCopy(currentDB)});
      if(undoStack.length>UNDO_LIMIT) undoStack.shift();
      redoStack = [];
      persistUIState();
      renderHealth();
    }
    function canUndo(){ return undoStack.length>0; }
    function canRedo(){ return redoStack.length>0; }
    function performUndo(){
      if(!canUndo()) return false;
      const last = undoStack.pop();
      redoStack.push({ts:Date.now(), db: deepCopy(currentDB)});
      currentDB = deepCopy(last.db);
      saveDB(currentDB);
      renderAll();
      showToast('Undo: '+last.action,'success');
      return true;
    }
    function performRedo(){
      if(!canRedo()) return false;
      const next = redoStack.pop();
      undoStack.push({ts:Date.now(), db: deepCopy(currentDB)});
      currentDB = deepCopy(next.db);
      saveDB(currentDB);
      renderAll();
      showToast('Redo','success');
      return true;
    }

    function autosave(action='autosave'){
      saveDB(currentDB);
      persistUIState();
      renderCounts();
      renderHealth();
    }

    function deepCopy(o){ return safeParseJSON(JSON.stringify(o), JSON.parse(JSON.stringify(DEFAULT_DB))); }

    /* Folders CRUD */
    function createFolder(name){
      if(!name || !name.trim()){ showToast('Folder name required','error'); return null; }
      pushUndo('Create Folder: ' + name);
      const f = { id:uid('f'), name: name.trim(), metaOverride: null, urls: []};
      currentDB.folders.push(f);
      autosave('createFolder');
      renderAll();
      showToast('Folder created','success');
      return f;
    }
    function renameFolder(id, newName){
      const f = findFolder(id);
      if(!f){ showToast('Folder not found','error'); return false; }
      pushUndo('Rename Folder: ' + f.name + ' -> ' + newName);
      f.name = newName;
      autosave('renameFolder');
      renderAll();
      return true;
    }
    function deleteFolder(id){
      const f = findFolder(id);
      if(!f){ showToast('Folder not found','error'); return false; }
      if(!AUTH.isAdmin()){ showToast('Admin required to delete folder','error'); return false; }
      pushUndo('Delete Folder: ' + f.name);
      currentDB.folders = currentDB.folders.filter(x=>x.id!==id);
      autosave('deleteFolder');
      renderAll();
      showToast('Folder deleted','success');
      return true;
    }
    function findFolder(id){ return currentDB.folders.find(f=>f.id===id); }

    /* URL CRUD */
    function validateUrlRecord(u){
      if(!u.loc || !String(u.loc).trim()) return {ok:false,err:'loc required'};
      if(!SITEMAP.validLoc(u.loc)) return {ok:false,err:'Invalid loc: must be absolute URL or start with /'};
      return {ok:true};
    }
    function addUrlToFolder(folderId, urlObj){
      const f = findFolder(folderId);
      if(!f){ showToast('Folder not found','error'); return null; }
      const tmp = Object.assign({}, urlTemplate(), urlObj);
      const v = validateUrlRecord(tmp);
      if(!v.ok){ showToast(v.err,'error'); return null; }
      pushUndo('Add URL to ' + f.name);
      tmp.id = uid('u');
      f.urls.push(tmp);
      if(currentDB.settings.autoUpdateLastmod) tmp.lastmod = (new Date()).toISOString();
      autosave('addUrl');
      renderAll();
      return tmp;
    }
    function editUrl(folderId, urlId, updates){
      const f = findFolder(folderId);
      if(!f) return false;
      const idx = f.urls.findIndex(u=>u.id===urlId);
      if(idx<0) return false;
      const copy = Object.assign({}, f.urls[idx], updates);
      const v = validateUrlRecord(copy);
      if(!v.ok){ showToast(v.err,'error'); return false; }
      pushUndo('Edit URL: ' + f.urls[idx].loc);
      f.urls[idx] = copy;
      if(currentDB.settings.autoUpdateLastmod) f.urls[idx].lastmod = (new Date()).toISOString();
      autosave('editUrl');
      renderAll();
      return true;
    }
    function deleteUrl(folderId, urlId){
      if(!AUTH.isAdmin()){ showToast('Admin required to delete URL','error'); return false; }
      const f = findFolder(folderId);
      if(!f) return false;
      const idx = f.urls.findIndex(u=>u.id===urlId);
      if(idx<0) return false;
      pushUndo('Delete URL: ' + f.urls[idx].loc);
      f.urls.splice(idx,1);
      autosave('deleteUrl');
      renderAll();
      return true;
    }
    function cloneUrl(folderId, urlId, toFolderId=null){
      const from = findFolder(folderId);
      if(!from) return false;
      const u = from.urls.find(x=>x.id===urlId);
      if(!u) return false;
      const target = toFolderId ? findFolder(toFolderId) : from;
      if(!target) return false;
      pushUndo('Clone URL: ' + u.loc);
      const copy = deepCopy(u);
      copy.id = uid('u');
      target.urls.push(copy);
      autosave('cloneUrl');
      renderAll();
      return true;
    }
    function moveUrl(fromFolderId, urlId, toFolderId){
      const from = findFolder(fromFolderId);
      const to = findFolder(toFolderId);
      if(!from || !to) return false;
      const idx = from.urls.findIndex(x=>x.id===urlId);
      if(idx<0) return false;
      pushUndo(`Move URL ${from.urls[idx].loc} -> ${to.name}`);
      const [u] = from.urls.splice(idx,1);
      to.urls.push(u);
      autosave('moveUrl');
      renderAll();
      return true;
    }

    function urlTemplate(){ return { loc: '', title: '', description: '', tags: [], network: 'internal', logo: '', lastmod: '', changefreq: '', priority: '' }; }

    /* =========================
       Import / Export / Reset
       ========================= */
    function exportDB(){
      const dataStr = JSON.stringify(currentDB, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'sg_db_export_'+(new Date().toISOString().slice(0,10))+'.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('Export started','success');
    }
    function importDBFromFile(file){
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const parsed = JSON.parse(String(e.target.result));
          if(!parsed || typeof parsed !== 'object' || !Array.isArray(parsed.folders)){ showToast('Invalid import file','error'); return; }
          parsed.schemaVersion = SCHEMA_VERSION;
          pushUndo('Import DB');
          currentDB = parsed;
          saveDB(currentDB);
          undoStack = []; redoStack = [];
          renderAll();
          showToast('Import successful','success');
        }catch(err){
          showToast('Import failed: ' + err.message,'error'); console.error(err);
        }
      };
      reader.readAsText(file);
    }
    function resetSystem(){
      if(!AUTH.isAdmin()){ showToast('Admin required to reset DB','error'); return; }
      if(!confirm('Reset system and delete all data? This action is irreversible.')) return;
      pushUndo('Reset DB');
      currentDB = JSON.parse(JSON.stringify(DEFAULT_DB));
      saveDB(currentDB);
      undoStack = []; redoStack = [];
      showToast('System reset','success');
      renderAll();
    }

    /* =========================
       UI Rendering & Router
       ========================= */
    const dom = {
      app: document.getElementById('app'),
      navTabs: document.getElementById('navTabs'),
      view: document.getElementById('view'),
      routeHint: document.getElementById('routeHint'),
      dbVersionLabel: document.getElementById('dbVersionLabel'),
      countsLabel: document.getElementById('countsLabel'),
      rightPanel: document.getElementById('rightPanel'),
      previewPanel: document.getElementById('previewPanel'),
      healthContent: document.getElementById('healthContent'),
      filterFolder: document.getElementById('filterFolder'),
      filterType: document.getElementById('filterType'),
      globalSearch: document.getElementById('globalSearch'),
      themeSelect: document.getElementById('themeSelect'),
      themeToggle: document.getElementById('themeToggle'),
      loginBtn: document.getElementById('loginBtn'),
      loginLabel: document.getElementById('loginLabel'),
      importBtn: document.getElementById('importBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      undoBtn: document.getElementById('undoBtn'),
      redoBtn: document.getElementById('redoBtn'),
      searchBtn: document.getElementById('searchBtn'),
      helpBtn: document.getElementById('helpBtn'),
      sidebar: document.getElementById('sidebar'),
      sidebarToggle: document.getElementById('sidebarToggle'),
      swipeHandle: document.getElementById('swipeHandle'),
      platformBadge: document.getElementById('platformBadge')
    };

    const ROUTES = ['dashboard','folders','urls','sitemap','meta','auth','dev'];
    let currentRoute = 'dashboard';

    function navigate(route, push=true){
      if(!ROUTES.includes(route)) route='dashboard';
      currentRoute = route;
      updateTabs();
      renderView(route);
      dom.routeHint.textContent = route[0].toUpperCase() + route.slice(1);
      if(push) history.pushState({route}, '', '#'+route);
    }

    window.addEventListener('popstate', (e)=> {
      const st = (e.state && e.state.route) ? e.state.route : (location.hash ? location.hash.slice(1) : 'dashboard');
      navigate(st, false);
    });

    function updateTabs(){
      Array.from(dom.navTabs.querySelectorAll('.tab')).forEach(t=>{
        if(t.dataset.route === currentRoute) t.classList.add('active'); else t.classList.remove('active');
      });
    }

    /* =========================
       Platform Detection & UI Variants
       - Adds classes to body: platform-mobile, platform-desktop, platform-ios, platform-android
       - Adjusts small bits of HTML (compact header) for mobile
       ========================= */
    const PLATFORM = detectPlatform();
    function detectPlatform(){
      const ua = navigator.userAgent || '';
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|Opera Mini/i.test(ua) || window.innerWidth < 900;
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isAndroid = /Android/.test(ua);
      return { isMobile, isDesktop: !isMobile, isIOS, isAndroid, ua };
    }

    function applyPlatformClasses(){
      const body = document.body;
      if(PLATFORM.isMobile) body.classList.add('platform-mobile'); else body.classList.add('platform-desktop');
      if(PLATFORM.isIOS) body.classList.add('platform-ios');
      if(PLATFORM.isAndroid) body.classList.add('platform-android');
      // show platform badge
      const badge = PLATFORM.isMobile ? (PLATFORM.isIOS ? 'iOS' : (PLATFORM.isAndroid ? 'Android' : 'Mobile')) : 'Desktop';
      dom.platformBadge.textContent = badge;
      // mobile: smaller title
      if(PLATFORM.isMobile){
        const titleBlock = document.getElementById('titleBlock');
        if(titleBlock) titleBlock.innerHTML = '<div style="font-weight:700">Sitemap Governance</div>';
      }
    }

    /* =========================
       Swipe Gesture Handling
       - Controlled for both touch and mouse (pointer)
       - If sidebar hidden, swiping right from left edge opens it
       - If sidebar visible, swiping left over sidebar closes it
       - Also provides a visible handle when hidden on mobile
       ========================= */
    let touchState = {startX:0, startY:0, active:false, isPointer:false};
    const SWIPE_THRESHOLD = 60; // px
    const EDGE_REGION = 36; // px from left edge to start open

    function onTouchStart(e){
      const p = (e.touches && e.touches[0]) || e;
      touchState.startX = p.clientX; touchState.startY = p.clientY; touchState.active = true; touchState.isPointer = !!e.pointerType;
    }
    function onTouchMove(e){
      if(!touchState.active) return;
      const p = (e.touches && e.touches[0]) || e;
      const dx = p.clientX - touchState.startX;
      const dy = p.clientY - touchState.startY;
      if(Math.abs(dx) < Math.abs(dy)) return; // vertical scroll
      // if starting near edge and swipe right
      if(!isSidebarVisible() && touchState.startX <= EDGE_REGION && dx > SWIPE_THRESHOLD){
        showSidebar(true);
        touchState.active = false;
      }
      // if sidebar visible and swipe left
      if(isSidebarVisible() && touchState.startX <= (getSidebarWidth()) && dx < -SWIPE_THRESHOLD){
        showSidebar(false);
        touchState.active = false;
      }
    }
    function onTouchEnd(e){ touchState.active = false; }

    function addGestureListeners(){
      // touch
      window.addEventListener('touchstart', onTouchStart, {passive:true});
      window.addEventListener('touchmove', onTouchMove, {passive:true});
      window.addEventListener('touchend', onTouchEnd);
      // pointer for mouse drag
      let pointerDown = false;
      window.addEventListener('pointerdown', (e)=>{ if(e.isPrimary){ onTouchStart(e); pointerDown=true; } });
      window.addEventListener('pointermove', (e)=>{ if(pointerDown) onTouchMove(e); });
      window.addEventListener('pointerup', (e)=>{ pointerDown=false; onTouchEnd(e); });
      // swipe handle click
      dom.swipeHandle.addEventListener('click', ()=> showSidebar(true));
      // sidebar toggle button
      dom.sidebarToggle.addEventListener('click', ()=> toggleSidebar());
      // adaptive visibility of handle
      window.addEventListener('resize', adjustSwipeHandle);
      adjustSwipeHandle();
    }

    function getSidebarWidth(){ return parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width')) || 260; }
    function isSidebarVisible(){ return !dom.sidebar.classList.contains('hidden'); }
    function showSidebar(show=true){
      if(show){
        dom.sidebar.classList.remove('hidden');
        dom.swipeHandle.classList.remove('visible');
        // on mobile ensure main layout shifts (CSS handles)
      }else{
        dom.sidebar.classList.add('hidden');
        // when hidden, show handle if mobile
        if(PLATFORM.isMobile) dom.swipeHandle.classList.add('visible');
      }
      persistUIState();
    }
    function toggleSidebar(){ showSidebar(!isSidebarVisible()); }
    function adjustSwipeHandle(){
      if(PLATFORM.isMobile && !isSidebarVisible()) dom.swipeHandle.classList.add('visible'); else dom.swipeHandle.classList.remove('visible');
      // position handle mid-left
      const appRect = document.getElementById('app').getBoundingClientRect();
      dom.swipeHandle.style.top = (appRect.top + appRect.height/2) + 'px';
    }

    /* =========================
       Search, Filters, Quick Utilities
       ========================= */
    function performSearch(q){
      q = String(q || '').trim().toLowerCase();
      if(!q){ showToast('Empty search','warn'); return; }
      const results = [];
      currentDB.folders.forEach(f=>{
        f.urls.forEach(u=>{
          const hay = [u.loc,u.title,u.description,(u.tags||[]).join(' '),f.name].join(' ').toLowerCase();
          if(hay.includes(q)) results.push({folder:f, url:u});
        });
      });
      const html = ['<div class="section-title"><strong>Search Results</strong><div class="small">'+results.length+' matches</div></div>'];
      if(!results.length) html.push('<div class="small">No results</div>');
      else{
        html.push('<div>');
        results.slice(0,200).forEach(r=>{
          html.push(`<div class="url-row"><div class="left"><img class="logo-thumb" src="${sanitizeUrl(r.url.logo) || ''}" onerror="this.style.display='none'"/>` +
                    `<div><div style="font-weight:600">${escapeHtml(r.url.title||r.url.loc)}</div><div class="small">${escapeHtml(r.url.loc)}</div></div></div>` +
                    `<div class="badge">${escapeHtml(r.folder.name)}</div></div>`);
        });
        html.push('</div>');
      }
      dom.view.innerHTML = html.join('');
      if(PLATFORM.isMobile) showSidebar(false);
    }

    /* =========================
       Renderers for each route
       (kept modular; reused logic from previous version)
       ========================= */
    function renderAll(){ renderCounts(); renderHealth(); renderFilters(); renderView(currentRoute); renderHeader(); META.setGlobal(currentDB); persistUIState(); }
    function renderHeader(){ document.getElementById('dbVersionLabel').textContent = 'Schema v' + currentDB.schemaVersion; document.getElementById('loginLabel').textContent = AUTH.isAdmin() ? 'Admin (on)' : 'Admin'; }
    function renderCounts(){ const folderCount = currentDB.folders.length; const urlCount = currentDB.folders.reduce((s,f)=>s+f.urls.length,0); document.getElementById('countsLabel').textContent = `${folderCount} folders • ${urlCount} URLs`; }
    function renderHealth(){ const urlCount = currentDB.folders.reduce((s,f)=>s+f.urls.length,0); const dupUrls = findDuplicateUrls(); const metaIssues = validateMeta(currentDB); const warnings = []; if(dupUrls.length) warnings.push(`${dupUrls.length} duplicate URLs`); if(metaIssues.length) warnings.push(`${metaIssues.length} meta issues`); const html = `<div>Folders: <strong>${currentDB.folders.length}</strong></div><div>URLs: <strong>${urlCount}</strong></div><div>Undo: <strong>${undoStack.length}</strong>, Redo: <strong>${redoStack.length}</strong></div><div style="margin-top:6px;color:var(--muted)">${warnings.length?('Warnings: '+warnings.join(' • ')):'System OK'}</div>`; dom.healthContent.innerHTML = html; }

    function renderFilters(){
      const sel = dom.filterFolder; if(!sel) return;
      sel.innerHTML = '<option value="">All Folders</option>';
      currentDB.folders.forEach(f=> { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; sel.appendChild(o); });
    }

    function renderView(route){
      switch(route){
        case 'dashboard': renderDashboard(); break;
        case 'folders': renderFolders(); break;
        case 'urls': renderUrlManager(); break;
        case 'sitemap': renderSitemap(); break;
        case 'meta': renderMetaManager(); break;
        case 'auth': renderAuthPanel(); break;
        case 'dev': renderDevTools(); break;
        default: renderDashboard();
      }
      // On mobile, auto-hide sidebar after navigating
      if(PLATFORM.isMobile) showSidebar(false);
    }

    /* -------------------------
       Dashboard
       ------------------------- */
    function renderDashboard(){
      const counts = currentDB.folders.reduce((acc,f)=>{ acc.urls += f.urls.length; return acc; }, {urls:0});
      const dup = findDuplicateUrls();
      const metaIssues = validateMeta(currentDB);
      const html = [];
      html.push(`<div class="section-title"><strong>Dashboard</strong><div class="small">Overview & quick actions</div></div>`);
      html.push(`<div class="grid columns-2" style="gap:12px">
        <div>
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${currentDB.folders.length}</strong><div class="small">Folders / Projects</div></div>
              <div><strong>${counts.urls}</strong><div class="small">Total URLs</div></div>
            </div>
            <div class="rule"></div>
            <div class="small">Use the Folder Manager to create and organize projects. Sitemap generator will only include sitemap fields.</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn primary" id="newFolderBtn"><i class="bi bi-folder-plus"></i> New Folder</button>
              <button class="btn" id="goToFoldersBtn">Open Folder Manager</button>
            </div>
          </div>

          <div style="margin-top:12px" class="list">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>Meta Health</strong><div class="small">${metaIssues.length} issues</div></div>
            <div class="small" style="margin-top:8px">${metaIssues.length? metaIssues.map(m=>`• ${m.issue} ${m.folder?('('+m.folder+')'):''}`).join('<br>') : 'No meta issues detected'}</div>
          </div>
        </div>
        <div>
          <div class="list">
            <strong>Quick Sitemap</strong>
            <div class="small">Generate sitemap for selected folders or all data.</div>
            <div class="rule"></div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="quickSitemapBtn"><i class="bi bi-file-earmark-code"></i> Build sitemap.xml</button>
              <button class="btn" id="quickIndexBtn"><i class="bi bi-journal"></i> Build sitemap-index.xml</button>
            </div>
            <div class="rule"></div>
            <div class="small">Duplicate URLs: <strong>${dup.length}</strong></div>
          </div>

          <div style="margin-top:12px" class="list">
            <strong>Recent Activity</strong>
            <div class="small" id="recentActivity">No recent activity</div>
          </div>
        </div>
      </div>`);

      dom.view.innerHTML = html.join('');

      document.getElementById('newFolderBtn').addEventListener('click', ()=>{
        const name = prompt('Folder name:');
        if(name) createFolder(name);
      });
      document.getElementById('goToFoldersBtn').addEventListener('click', ()=>navigate('folders'));
      document.getElementById('quickSitemapBtn').addEventListener('click', ()=>{ navigate('sitemap'); setTimeout(()=>document.getElementById('buildAllBtn')?.click(),200); });
      document.getElementById('quickIndexBtn').addEventListener('click', ()=>{ navigate('sitemap'); setTimeout(()=>document.getElementById('buildIndexBtn')?.click(),200); });
    }

    /* -------------------------
       Folder Manager
       ------------------------- */
    function renderFolders(){
      const html = ['<div class="section-title"><strong>Folder / Project Manager</strong><div class="small">Create, rename, reorder, and delete projects (Admin-only delete)</div></div>'];
      html.push('<div style="display:flex;gap:12px"><div style="flex:1"><div class="list">');
      html.push('<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><strong>Folders</strong></div><div><button class="btn" id="addFolderBtn"><i class="bi bi-plus"></i> Add</button></div></div>');
      if(!currentDB.folders.length) html.push('<div class="small">No folders. Add one to get started.</div>');
      else{
        currentDB.folders.forEach(f=>{
          html.push(`<div class="folder-item" data-id="${f.id}"><div><div style="font-weight:600">${escapeHtml(f.name)}</div><div class="meta small">${f.urls.length} URLs</div></div>
            <div style="display:flex;gap:6px">
              <button class="btn" data-act="open" title="Open"><i class="bi bi-box-arrow-up-right"></i></button>
              <button class="btn" data-act="rename" title="Rename"><i class="bi bi-pencil"></i></button>
              <button class="btn" data-act="meta" title="Meta override"><i class="bi bi-meta"></i></button>
              <button class="btn" data-act="delete" title="Delete"><i class="bi bi-trash"></i></button>
            </div></div>`);
        });
      }
      html.push('</div></div><div style="width:320px"><div class="list"><strong>Folder Details</strong><div class="small" id="folderDetails">Select a folder to edit its properties and view URLs.</div></div></div></div>');
      dom.view.innerHTML = html.join('');

      document.getElementById('addFolderBtn').addEventListener('click', ()=>{
        const name = prompt('Folder name:');
        if(name) createFolder(name);
      });

      Array.from(dom.view.querySelectorAll('.folder-item')).forEach(el=>{
        const id = el.dataset.id;
        el.querySelector('[data-act="open"]').addEventListener('click', ()=>{ navigate('urls'); setTimeout(()=>renderFolderInUrlPanel(id), 150); });
        el.querySelector('[data-act="rename"]').addEventListener('click', ()=>{
          const newName = prompt('New name:', findFolder(id).name);
          if(newName) renameFolder(id, newName);
        });
        el.querySelector('[data-act="meta"]').addEventListener('click', ()=>{
          const f = findFolder(id);
          const desc = f.metaOverride && f.metaOverride.description ? f.metaOverride.description : '';
          const title = f.metaOverride && f.metaOverride.title ? f.metaOverride.title : '';
          const keywords = f.metaOverride && f.metaOverride.keywords ? f.metaOverride.keywords : '';
          const author = f.metaOverride && f.metaOverride.author ? f.metaOverride.author : '';
          const robots = f.metaOverride && f.metaOverride.robots ? f.metaOverride.robots : '';
          const titleN = prompt('Per-folder title override (leave empty to clear):', title);
          const descN = prompt('Per-folder description override (leave empty to clear):', desc);
          const keywordsN = prompt('Keywords (comma separated):', keywords);
          const authorN = prompt('Author:', author);
          const robotsN = prompt('Robots:', robots);
          pushUndo('Folder meta override: ' + f.name);
          f.metaOverride = (titleN||descN||keywordsN||authorN||robotsN) ? {title: titleN, description: descN, keywords: keywordsN, author: authorN, robots: robotsN} : null;
          autosave('folderMeta');
          renderAll();
        });
        el.querySelector('[data-act="delete"]').addEventListener('click', ()=>{ if(confirm('Delete folder and all URLs?')) deleteFolder(id); });
      });
    }

    function renderFolderInUrlPanel(folderId){ navigate('urls'); setTimeout(()=> { const select = dom.view.querySelector('.select-folder-filter'); if(select) select.value = folderId; renderUrlManager(folderId); },100); }

    /* -------------------------
       URL Manager
       ------------------------- */
    function renderUrlManager(preselectFolderId){
      const html = [];
      html.push('<div class="section-title"><strong>URL Manager</strong><div class="small">Add, edit, clone, move, and manage URLs. Undo/Redo supported.</div></div>');
      html.push('<div style="display:flex;gap:12px"><div style="flex:1"><div class="list">');
      html.push('<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><strong>URLs</strong></div><div class="toolbar"><select class="input select-folder-filter" style="width:240px"><option value="">All folders</option></select><button class="btn" id="newUrlBtn"><i class="bi bi-plus"></i> New URL</button></div></div>');
      html.push('<div id="urlListContainer"></div>');
      html.push('</div></div><div style="width:320px"><div class="list"><strong>URL Editor</strong><div id="urlEditorPanel" class="small">Select a URL to edit or create a new one.</div></div></div></div>');
      dom.view.innerHTML = html.join('');

      const sel = dom.view.querySelector('.select-folder-filter');
      currentDB.folders.forEach(f=> { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; sel.appendChild(o); });
      if(preselectFolderId) sel.value = preselectFolderId;

      dom.view.querySelector('#newUrlBtn').addEventListener('click', ()=> openUrlEditor({folderId: sel.value || (currentDB.folders[0] && currentDB.folders[0].id)}));
      sel.addEventListener('change', ()=> renderUrlList(sel.value));

      renderUrlList(sel.value);
    }

    function renderUrlList(folderId){
      const container = dom.view.querySelector('#urlListContainer');
      container.innerHTML = '';
      const foldersToShow = folderId ? currentDB.folders.filter(f=>f.id===folderId) : currentDB.folders;
      if(!foldersToShow.length){ container.innerHTML = '<div class="small">No folders available</div>'; return; }
      foldersToShow.forEach(f=>{
        const h = document.createElement('div');
        h.innerHTML = `<div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">${escapeHtml(f.name)}</div><div class="small">${f.urls.length} URLs</div></div>`;
        const list = document.createElement('div');
        list.className = 'list';
        if(!f.urls.length) list.innerHTML = '<div class="small">No URLs</div>';
        else{
          f.urls.forEach(u=>{
            const row = document.createElement('div');
            row.className = 'url-row';
            row.innerHTML = `<div class="left"><input type="checkbox" class="select-url" data-folder="${f.id}" data-url="${u.id}" aria-label="Select URL">
                <img class="logo-thumb" src="${sanitizeUrl(u.logo)||''}" onerror="this.style.display='none'"/>
                <div><div style="font-weight:600">${escapeHtml(u.title || u.loc)}</div><div class="small">${escapeHtml(u.loc)}</div></div></div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                  <div style="display:flex;gap:6px">
                    <button class="btn" data-act="edit" data-folder="${f.id}" data-url="${u.id}" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn" data-act="clone" data-folder="${f.id}" data-url="${u.id}" title="Clone"><i class="bi bi-files"></i></button>
                    <button class="btn" data-act="move" data-folder="${f.id}" data-url="${u.id}" title="Move"><i class="bi bi-arrow-right-square"></i></button>
                    <button class="btn" data-act="delete" data-folder="${f.id}" data-url="${u.id}" title="Delete"><i class="bi bi-trash"></i></button>
                  </div>
                  <div class="small">${u.tags && u.tags.length ? u.tags.map(t=>'<span class="tag">'+escapeHtml(t)+'</span>').join(' ') : ''}</div>
                </div>`;
            list.appendChild(row);
          });
        }
        h.appendChild(list);
        container.appendChild(h);
      });

      Array.from(container.querySelectorAll('button[data-act]')).forEach(btn=>{
        const act = btn.dataset.act;
        if(act==='edit') btn.addEventListener('click', ()=> openUrlEditor({folderId:btn.dataset.folder, urlId:btn.dataset.url}));
        if(act==='clone') btn.addEventListener('click', ()=> {
          const toFolder = prompt('Target folder id (leave empty to same folder):');
          cloneUrl(btn.dataset.folder, btn.dataset.url, toFolder || null);
        });
        if(act==='move') btn.addEventListener('click', ()=> {
          const target = prompt('Target folder id:');
          if(target) moveUrl(btn.dataset.folder, btn.dataset.url, target);
        });
        if(act==='delete') btn.addEventListener('click', ()=> {
          if(confirm('Delete URL?')) deleteUrl(btn.dataset.folder, btn.dataset.url);
        });
      });

      Array.from(container.querySelectorAll('.select-url')).forEach(cb=>{
        cb.addEventListener('change', (e)=> { const fId = cb.dataset.folder; const uId = cb.dataset.url; if(cb.checked) showPreview(fId, uId); });
      });
    }

    function openUrlEditor({folderId, urlId} = {}){
      const panel = dom.view.querySelector('#urlEditorPanel');
      const folder = folderId ? findFolder(folderId) : (currentDB.folders[0]||null);
      if(!folder){ panel.innerHTML = '<div class="small">No folder available. Create a folder first.</div>'; return; }
      const record = urlId ? (folder.urls.find(u=>u.id===urlId) || null) : null;
      const r = record ? Object.assign({}, record) : urlTemplate();
      const html = [];
      html.push('<div style="display:grid;gap:8px">');
      html.push(`<label class="small">Folder</label><select id="editorFolder" class="input">${currentDB.folders.map(f=>`<option value="${f.id}" ${f.id===folder.id?'selected':''}>${escapeHtml(f.name)}</option>`).join('')}</select>`);
      html.push(`<label class="small">URL (loc)</label><input id="editorLoc" class="input" value="${escapeAttr(r.loc)}" placeholder="https://example.com/path">`);
      html.push(`<label class="small">Title</label><input id="editorTitle" class="input" value="${escapeAttr(r.title)}">`);
      html.push(`<label class="small">Description</label><textarea id="editorDesc" class="input">${escapeAttr(r.description)}</textarea>`);
      html.push(`<label class="small">Tags (comma separated)</label><input id="editorTags" class="input" value="${escapeAttr((r.tags||[]).join(','))}">`);
      html.push(`<label class="small">Network Type</label><select id="editorNetwork" class="input"><option value="internal">Internal</option><option value="external">External</option><option value="third-party">Third-party</option></select>`);
      html.push(`<label class="small">Logo URL (optional)</label><input id="editorLogo" class="input" value="${escapeAttr(r.logo)}">`);
      html.push(`<div class="rule"></div><div class="small">Sitemap fields (only these will be in XML)</div>`);
      html.push(`<label class="small">Last Modified (ISO)</label><input id="editorLastmod" class="input" value="${escapeAttr(r.lastmod)}">`);
      html.push(`<label class="small">Change Frequency</label><select id="editorChangefreq" class="input"><option value="">(leave empty)</option><option>always</option><option>hourly</option><option>daily</option><option>weekly</option><option>monthly</option><option>yearly</option><option>never</option></select>`);
      html.push(`<label class="small">Priority (0.0 - 1.0)</label><input id="editorPriority" class="input" value="${escapeAttr(r.priority)}">`);
      html.push(`<div style="display:flex;gap:8px;margin-top:6px"><button class="btn primary" id="saveUrlBtn"><i class="bi bi-save"></i> Save</button><button class="btn" id="cancelUrlBtn">Cancel</button></div>`);
      html.push('</div>');
      panel.innerHTML = html.join('');

      panel.querySelector('#editorNetwork').value = r.network || 'internal';
      panel.querySelector('#editorChangefreq').value = r.changefreq || '';

      panel.querySelector('#saveUrlBtn').addEventListener('click', ()=>{
        const updated = {
          loc: panel.querySelector('#editorLoc').value.trim(),
          title: panel.querySelector('#editorTitle').value.trim(),
          description: panel.querySelector('#editorDesc').value.trim(),
          tags: panel.querySelector('#editorTags').value.split(',').map(s=>s.trim()).filter(Boolean),
          network: panel.querySelector('#editorNetwork').value,
          logo: panel.querySelector('#editorLogo').value.trim(),
          lastmod: panel.querySelector('#editorLastmod').value.trim(),
          changefreq: panel.querySelector('#editorChangefreq').value,
          priority: panel.querySelector('#editorPriority').value.trim()
        };
        const targetFolderId = panel.querySelector('#editorFolder').value;
        if(urlId){
          const t = editUrl(folder.id, urlId, updated);
          if(t) showToast('URL updated','success');
        }else{
          const a = addUrlToFolder(targetFolderId, updated);
          if(a) showToast('URL added','success');
        }
      });
      panel.querySelector('#cancelUrlBtn').addEventListener('click', ()=>{ panel.innerHTML = '<div class="small">Canceled</div>'; });
    }

    function showPreview(folderId, urlId){
      const f = findFolder(folderId); if(!f) return;
      const u = f.urls.find(x=>x.id===urlId); if(!u) return;
      const html = [];
      html.push(`<div style="display:flex;gap:8px"><img class="logo-thumb" src="${sanitizeUrl(u.logo)||''}" onerror="this.style.display='none'"/><div><div style="font-weight:700">${escapeHtml(u.title||u.loc)}</div><div class="small">${escapeHtml(u.loc)}</div><div style="margin-top:6px">${escapeHtml(u.description||'')}</div><div style="margin-top:8px">${(u.tags||[]).map(t=>'<span class="tag">'+escapeHtml(t)+'</span>').join(' ')}</div></div></div>`);
      html.push('<div class="rule"></div>');
      html.push('<div class="small">Network: '+escapeHtml(u.network)+'</div>');
      html.push('<div class="small">Sitemap: lastmod: '+escapeHtml(u.lastmod)+' • changefreq: '+escapeHtml(u.changefreq)+' • priority: '+escapeHtml(u.priority)+'</div>');
      dom.previewPanel.innerHTML = html.join('');
    }

    /* -------------------------
       Sitemap Generator View
       ------------------------- */
    function renderSitemap(){
      const html = [];
      html.push('<div class="section-title"><strong>Sitemap Generator</strong><div class="small">Select URLs to include and generate sitemap.xml or sitemap-index.xml. Manual XML edit (Admin only).</div></div>');
      html.push('<div style="display:flex;gap:12px"><div style="flex:1"><div class="list">');
      html.push('<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn" id="selectAllBtn">Select All</button><button class="btn" id="clearAllBtn">Clear</button><button class="btn" id="buildAllBtn">Build sitemap.xml</button><button class="btn" id="buildIndexBtn">Build sitemap-index.xml</button><button class="btn" id="downloadSitemapBtn">Download</button><button class="btn" id="copySitemapBtn">Copy</button></div>');
      html.push('<div id="sitemapList"></div>');
      html.push('</div></div><div style="width:360px"><div class="list"><strong>Preview & Actions</strong><div class="small">XML preview and manual editor</div><div class="rule"></div><div id="xmlPreview" class="xml-preview">No sitemap generated yet</div><div class="rule"></div>');
      html.push('<div style="display:flex;gap:8px"><button class="btn" id="manualEditBtn"><i class="bi bi-pencil-square"></i> Manual Edit</button><button class="btn" id="shareBtn"><i class="bi bi-share"></i> Share</button></div>');
      html.push('<div style="margin-top:8px" class="small">Manual edit is restricted to Admin mode.</div></div></div></div>');
      dom.view.innerHTML = html.join('');

      const list = dom.view.querySelector('#sitemapList');
      currentDB.folders.forEach(f=>{
        const s = document.createElement('div');
        s.innerHTML = `<div style="font-weight:600;margin-bottom:6px">${escapeHtml(f.name)} <span class="small">(${f.urls.length})</span></div>`;
        const ul = document.createElement('div'); ul.style.paddingLeft='8px';
        f.urls.forEach(u=>{
          const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='6px'; row.style.borderBottom='1px solid rgba(0,0,0,0.02)';
          const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.folder=f.id; cb.dataset.url=u.id; cb.className='sitemap-select';
          left.appendChild(cb);
          const ttl = document.createElement('div'); ttl.innerHTML = `<div style="font-weight:600">${escapeHtml(u.title||u.loc)}</div><div class="small">${escapeHtml(u.loc)}</div>`;
          left.appendChild(ttl);
          const right = document.createElement('div'); right.innerHTML = `<div class="small">lastmod:${escapeHtml(u.lastmod)} • ${escapeHtml(u.changefreq)} • pr:${escapeHtml(SITEMAP.normalizePriority(u.priority)||'')}</div>`;
          row.appendChild(left); row.appendChild(right); ul.appendChild(row);
        });
        s.appendChild(ul); list.appendChild(s);
      });

      dom.view.querySelector('#selectAllBtn').addEventListener('click', ()=> Array.from(dom.view.querySelectorAll('.sitemap-select')).forEach(cb=>cb.checked=true));
      dom.view.querySelector('#clearAllBtn').addEventListener('click', ()=> Array.from(dom.view.querySelectorAll('.sitemap-select')).forEach(cb=>cb.checked=false));
      dom.view.querySelector('#buildAllBtn').addEventListener('click', ()=> {
        const selected = gatherSelectedUrls();
        if(!selected.length){ showToast('No URLs selected','warn'); return; }
        if(currentDB.settings.autoUpdateLastmod){
          const now = (new Date()).toISOString();
          selected.forEach(u=>{ u.lastmod = now; });
        }
        const xml = SITEMAP.buildSitemap(selected);
        dom.view.querySelector('#xmlPreview').textContent = xml;
        showToast('Sitemap generated','success');
        currentDB._lastGenerated = {type:'sitemap',ts:Date.now(),xml};
      });
      dom.view.querySelector('#buildIndexBtn').addEventListener('click', ()=>{
        const sitemaps = [];
        currentDB.folders.forEach(f=>{
          if(f.urls.length===0) return;
          const xml = SITEMAP.buildSitemap(f.urls);
          const blob = new Blob([xml], {type:'application/xml'});
          const url = URL.createObjectURL(blob);
          sitemaps.push({loc:url, lastmod:(new Date()).toISOString()});
        });
        const indexXml = SITEMAP.buildSitemapIndex(sitemaps);
        dom.view.querySelector('#xmlPreview').textContent = indexXml;
        showToast('Sitemap index generated','success');
        currentDB._lastGenerated = {type:'index',ts:Date.now(),xml:indexXml,sitemaps};
      });
      dom.view.querySelector('#downloadSitemapBtn').addEventListener('click', ()=>{
        if(!currentDB._lastGenerated || !currentDB._lastGenerated.xml){ showToast('No sitemap to download','warn'); return; }
        const blob = new Blob([currentDB._lastGenerated.xml], {type:'application/xml'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = currentDB._lastGenerated.type==='index' ? 'sitemap-index.xml' : 'sitemap.xml';
        document.body.appendChild(a); a.click(); a.remove();
        showToast('Download started','success');
      });
      dom.view.querySelector('#copySitemapBtn').addEventListener('click', async ()=>{
        if(!currentDB._lastGenerated || !currentDB._lastGenerated.xml){ showToast('No sitemap','warn'); return; }
        try{ await navigator.clipboard.writeText(currentDB._lastGenerated.xml); showToast('Sitemap copied','success'); }catch(e){ showToast('Copy failed','error'); }
      });
      dom.view.querySelector('#manualEditBtn').addEventListener('click', async ()=>{
        if(!AUTH.isAdmin()){ const ok = await AUTH.ensureAdmin(); if(!ok) return; }
        const current = localStorage.getItem(MANUAL_SITEMAP_KEY) || (currentDB._lastGenerated ? currentDB._lastGenerated.xml : '');
        const newXml = prompt('Edit sitemap XML (replace entire content):', current || '');
        if(newXml==null) return;
        const valid = SITEMAP.validateXMLString(newXml);
        if(!valid.ok && !confirm('XML seems invalid. Save anyway? ' + (valid.error||''))) return;
        localStorage.setItem(MANUAL_SITEMAP_KEY, newXml);
        dom.view.querySelector('#xmlPreview').textContent = newXml;
        showToast('Manual sitemap saved','success');
      });
      dom.view.querySelector('#shareBtn').addEventListener('click', async ()=>{
        if(!currentDB._lastGenerated || !currentDB._lastGenerated.xml){ showToast('No sitemap to share','warn'); return; }
        if(navigator.share){
          try{
            const blob = new Blob([currentDB._lastGenerated.xml], {type:'application/xml'});
            const filesArray = [new File([blob], currentDB._lastGenerated.type==='index'?'sitemap-index.xml':'sitemap.xml', {type:'application/xml'})];
            await navigator.share({title:'Sitemap',files:filesArray,text:'Sitemap generated by SG'});
            showToast('Share invoked','success');
          }catch(e){ showToast('Share failed','error'); }
        }else{ showToast('Web Share API not supported','warn'); }
      });

      const manual = localStorage.getItem(MANUAL_SITEMAP_KEY);
      if(manual) dom.view.querySelector('#xmlPreview').textContent = manual;
    }

    function gatherSelectedUrls(){
      const selected = [];
      Array.from(dom.view.querySelectorAll('.sitemap-select')).forEach(cb=>{
        if(cb.checked){
          const folder = findFolder(cb.dataset.folder);
          const url = folder && folder.urls.find(u=>u.id===cb.dataset.url);
          if(url) selected.push(url);
        }
      });
      return selected;
    }

    /* -------------------------
       Meta Manager
       ------------------------- */
    function renderMetaManager(){
      const html = [];
      html.push('<div class="section-title"><strong>SEO & Meta Manager</strong><div class="small">Manage global meta tags and per-folder overrides. Admin-only meta overrides for enforcement.</div></div>');
      html.push('<div style="display:grid;grid-template-columns:1fr 360px;gap:12px"><div class="list">');
      html.push('<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Global Meta</strong><div class="small">These apply network-wide unless overridden</div></div><div><button class="btn" id="saveMetaBtn">Save</button></div></div>');
      html.push('<div style="margin-top:8px"><label class="small">Title</label><input id="metaTitle" class="input" value="'+escapeAttr(currentDB.meta.title)+'">');
      html.push('<label class="small">Description</label><textarea id="metaDescription" class="input">'+escapeAttr(currentDB.meta.description)+'</textarea>');
      html.push('<label class="small">Keywords</label><input id="metaKeywords" class="input" value="'+escapeAttr(currentDB.meta.keywords)+'">');
      html.push('<label class="small">Author</label><input id="metaAuthor" class="input" value="'+escapeAttr(currentDB.meta.author)+'">');
      html.push('<label class="small">Robots</label><input id="metaRobots" class="input" value="'+escapeAttr(currentDB.meta.robots)+'"></div>');
      html.push('</div><div class="list"><strong>Validation</strong><div class="small" id="metaValidation">Checking...</div></div></div>');
      dom.view.innerHTML = html.join('');
      document.getElementById('saveMetaBtn').addEventListener('click', ()=>{
        const nmeta = {
          title: document.getElementById('metaTitle').value.trim(),
          description: document.getElementById('metaDescription').value.trim(),
          keywords: document.getElementById('metaKeywords').value.trim(),
          author: document.getElementById('metaAuthor').value.trim(),
          robots: document.getElementById('metaRobots').value.trim()
        };
        if(!nmeta.description){ showToast('Meta description cannot be empty','error'); return; }
        if(nmeta.description.length < META.limits.descriptionMin || nmeta.description.length > META.limits.descriptionMax){ showToast('Meta description length out of bounds','warn'); }
        pushUndo('Global meta update');
        currentDB.meta = nmeta;
        autosave('metaSave');
        META.setGlobal(currentDB);
        showToast('Meta saved','success');
      });
      const issues = validateMeta(currentDB);
      document.getElementById('metaValidation').innerHTML = issues.length ? issues.map(i=>`• ${i.issue} ${i.folder?('('+i.folder+')'):''}`).join('<br>') : 'No validation issues';
    }

    /* -------------------------
       Auth Panel
       ------------------------- */
    function renderAuthPanel(){
      const html = [];
      html.push('<div class="section-title"><strong>Authorization Panel</strong><div class="small">Manage admin passcode, session, and security options. Passcode is hashed before storage.</div></div>');
      html.push('<div class="list"><div class="small">Admin session: <strong>' + (AUTH.isAdmin() ? 'Active' : 'Inactive') + '</strong></div>');
      html.push('<div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="setPassBtn">Set / Reset Passcode</button><button class="btn" id="loginActionBtn">'+(AUTH.isAdmin()?'Logout':'Login')+'</button></div>');
      html.push('<div class="rule"></div><div class="small">Passcode is stored hashed with SHA-256 and a random salt. Session is stored in sessionStorage and expires on tab close.</div></div>');
      dom.view.innerHTML = html.join('');
      document.getElementById('setPassBtn').addEventListener('click', async ()=>{
        const ok = await AUTH.ensureAdmin('Enter current admin passcode to change (leave empty if none set):');
        let proceed = true;
        if(!AUTH.isPassSet()) proceed = confirm('No existing passcode detected. Create one now?');
        if(!proceed) return;
        const newPass = prompt('Enter new admin passcode:');
        if(!newPass) return;
        await AUTH.setPass(newPass);
        showToast('Passcode set','success');
        renderAll();
      });
      document.getElementById('loginActionBtn').addEventListener('click', async ()=>{
        if(AUTH.isAdmin()){ AUTH.logoutSession(); showToast('Logged out','success'); renderAll(); } else { const ok = await AUTH.ensureAdmin(); if(ok) renderAll(); }
      });
    }

    /* -------------------------
       Developer Tools
       ------------------------- */
    function renderDevTools(){
      const dbJson = JSON.stringify(currentDB, null, 2);
      const html = [];
      html.push('<div class="section-title"><strong>Developer Tools</strong><div class="small">Diagnostics, integrity checks, import/export, and manual DB reset (Admin-only)</div></div>');
      html.push('<div style="display:grid;grid-template-columns:1fr 360px;gap:12px"><div class="list"><strong>System Integrity</strong><div class="small" id="integrityPanel"></div><div class="rule"></div>');
      html.push('<div style="display:flex;gap:8px"><button class="btn" id="runChecksBtn">Run Checks</button><button class="btn" id="resetBtn">Reset DB</button></div>');
      html.push('<div class="rule"></div><strong>Raw DB</strong><pre style="white-space:pre-wrap;font-family:monospace;font-size:12px;padding:8px;border-radius:6px;background:var(--glass)">'+escapeHtml(dbJson)+'</pre></div>');
      html.push('<div class="list"><strong>Quick Utilities</strong><div class="small" style="margin-top:8px"><button class="btn" id="exportBtn2">Export DB</button><button class="btn" id="importBtn2">Import DB</button><button class="btn" id="validateXmlBtn">Validate Last Sitemap XML</button></div><div style="margin-top:8px" id="devOutput"></div></div></div>');
      dom.view.innerHTML = html.join('');
      document.getElementById('runChecksBtn').addEventListener('click', ()=> {
        const issues = runIntegrityChecks();
        document.getElementById('integrityPanel').innerHTML = issues.length ? issues.map(i=>`• ${i}`).join('<br>') : 'No integrity issues';
        showToast('Checks complete','success');
      });
      document.getElementById('resetBtn').addEventListener('click', resetSystem);
      document.getElementById('exportBtn2').addEventListener('click', exportDB);
      document.getElementById('importBtn2').addEventListener('click', ()=> dom.importFile.click());
      document.getElementById('validateXmlBtn').addEventListener('click', ()=>{
        const xml = (currentDB._lastGenerated && currentDB._lastGenerated.xml) || localStorage.getItem(MANUAL_SITEMAP_KEY) || '';
        if(!xml){ showToast('No XML to validate','warn'); return; }
        const res = SITEMAP.validateXMLString(xml);
        const out = document.getElementById('devOutput');
        out.innerHTML = '<div class="small">'+(res.ok?('XML valid'):(`XML invalid: ${escapeHtml(res.error)}`))+'</div>';
      });
    }

    /* -------------------------
       Integrity & Helpers
       ------------------------- */
    function findDuplicateUrls(){
      const map = new Map(); const dups = [];
      currentDB.folders.forEach(f=>{
        f.urls.forEach(u=>{
          const key = String(u.loc).trim().toLowerCase();
          if(map.has(key)) dups.push({loc:u.loc, folders:[map.get(key), f.name]});
          else map.set(key, f.name);
        });
      });
      return dups;
    }
    function runIntegrityChecks(){
      const issues=[];
      const ids = new Set();
      currentDB.folders.forEach(f=>{
        if(ids.has(f.id)) issues.push('Duplicate folder id: '+f.id); else ids.add(f.id);
        f.urls.forEach(u=>{
          if(ids.has(u.id)) issues.push('Duplicate url id: '+u.id); else ids.add(u.id);
          if(!u.loc) issues.push('Empty loc in url id: '+u.id);
          if(!SITEMAP.validLoc(u.loc)) issues.push('Invalid loc: '+u.loc);
          if(!SITEMAP.validChangefreq(u.changefreq) && u.changefreq) issues.push('Invalid changefreq:'+u.changefreq+' for '+u.loc);
          const pr = SITEMAP.normalizePriority(u.priority);
          if(pr!=='' && (isNaN(Number(pr)) || Number(pr)<0 || Number(pr)>1)) issues.push('Invalid priority for '+u.loc);
        });
      });
      const metaIssues = validateMeta(currentDB);
      metaIssues.forEach(m=>issues.push('Meta: '+m.issue+(m.folder?(' ('+m.folder+')'):'')));
      return issues;
    }

    /* =========================
       Utilities & Helpers
       ========================= */
    function showToast(msg, type='success', ttl=3500){
      const toastContainer = document.getElementById('toasts');
      const t = document.createElement('div');
      t.className = 'toast ' + (type==='error' ? 'error' : (type==='warn' ? 'warn' : 'success'));
      t.innerHTML = `<div style="flex:1">${escapeHtml(msg)}</div><div style="opacity:.9;min-width:30px;text-align:right;color:rgba(255,255,255,0.9)"><button style="background:transparent;border:0;color:inherit;cursor:pointer" aria-label="Dismiss">✖</button></div>`;
      t.querySelector('button').addEventListener('click', ()=> t.remove());
      toastContainer.appendChild(t);
      setTimeout(()=>{ t.remove(); }, ttl);
    }
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
    function sanitizeUrl(u){ if(!u) return ''; try{ const s = String(u).trim(); if(s.startsWith('data:')) return s; const url = new URL(s, location.origin); return url.toString(); }catch(e){ return String(u); } }
    function bytesToHex(bytes){ return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function hexToBytes(hex){ const len = hex.length/2; const out = new Uint8Array(len); for(let i=0;i<len;i++) out[i]=parseInt(hex.substr(i*2,2),16); return out; }

    /* =========================
       Shortcuts & helpers wiring
       ========================= */
    function globalShortcuts(e){
      if(e.ctrlKey && !e.shiftKey && !e.altKey){
        if(e.key === '1'){ e.preventDefault(); navigate('dashboard'); }
        if(e.key === '2'){ e.preventDefault(); navigate('folders'); }
        if(e.key === '3'){ e.preventDefault(); navigate('urls'); }
        if(e.key === '4'){ e.preventDefault(); navigate('sitemap'); }
        if(e.key === '5'){ e.preventDefault(); navigate('meta'); }
        if(e.key === '6'){ e.preventDefault(); navigate('auth'); }
        if(e.key === '7'){ e.preventDefault(); navigate('dev'); }
        if(e.key === 'z'){ if(!e.shiftKey){ e.preventDefault(); performUndo(); } }
        if(e.key === 'y'){ e.preventDefault(); performRedo(); }
        if(e.key === 'f'){ e.preventDefault(); document.getElementById('globalSearch').focus(); }
      }
    }
    function showHelp(){ alert('Keyboard Shortcuts:\\nCtrl+1..7 switch tabs\\nCtrl+Z Undo, Ctrl+Y Redo\\nCtrl+F Focus search\\nSwipe from left edge to open navigation on mobile.'); }

    /* =========================
       Theme Management
       - Supports auto/light/dark/sepia
       - Also changes small HTML variant for certain platforms if needed
       ========================= */
    function applyTheme(pref){
      if(pref === 'auto'){
        const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
      }else{
        document.documentElement.setAttribute('data-theme', pref === 'dark' ? 'dark' : (pref==='sepia' ? 'sepia' : 'light'));
      }
      localStorage.setItem(THEME_KEY, pref);
      // Example of theme-based small DOM modification: change header badge contrast slightly
      if(pref === 'sepia') document.body.classList.add('theme-sepia'); else document.body.classList.remove('theme-sepia');
    }
    function cycleTheme(){
      const cur = localStorage.getItem(THEME_KEY) || 'auto';
      const order = ['auto','light','dark','sepia'];
      const next = order[(order.indexOf(cur)+1)%order.length];
      localStorage.setItem(THEME_KEY, next);
      document.getElementById('themeSelect').value = next;
      applyTheme(next);
      showToast('Theme: ' + next,'success');
    }

    /* =========================
       Persistence for UI state (sidebar hidden, undo size etc)
       ========================= */
    function persistUIState(){
      const state = { sidebarHidden: dom.sidebar.classList.contains('hidden'), ts:Date.now(), undo:undoStack.length, redo:redoStack.length };
      localStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
    }
    function restoreUIState(){
      const raw = localStorage.getItem(UI_STATE_KEY);
      const s = safeParseJSON(raw, {});
      if(s && s.sidebarHidden) dom.sidebar.classList.add('hidden'); else dom.sidebar.classList.remove('hidden');
      // ensure swipe handle visibility
      if(PLATFORM.isMobile && dom.sidebar.classList.contains('hidden')) dom.swipeHandle.classList.add('visible'); else dom.swipeHandle.classList.remove('visible');
    }

    /* =========================
       Attach events & init
       ========================= */
    function init(){
      applyPlatformClasses();
      addGestureListeners();
      // event binding for nav
      dom.navTabs.addEventListener('click', (e)=>{ const t = e.target.closest('.tab'); if(t && t.dataset.route) navigate(t.dataset.route); });
      dom.loginBtn.addEventListener('click', onLoginClick);
      dom.themeSelect.addEventListener('change', (e)=>{ localStorage.setItem(THEME_KEY, e.target.value); applyTheme(e.target.value); });
      dom.themeToggle.addEventListener('click', ()=> cycleTheme());
      dom.importBtn.addEventListener('click', ()=> dom.importFile.click());
      dom.exportBtn.addEventListener('click', exportDB);
      dom.importFile.addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) importDBFromFile(e.target.files[0]); e.target.value=''; });
      dom.undoBtn.addEventListener('click', performUndo);
      dom.redoBtn.addEventListener('click', performRedo);
      dom.searchBtn.addEventListener('click', ()=>performSearch(dom.globalSearch.value));
      dom.helpBtn.addEventListener('click', showHelp);
      document.addEventListener('keydown', globalShortcuts);

      // platform-specific initial theme
      const savedTheme = localStorage.getItem(THEME_KEY) || 'auto';
      document.getElementById('themeSelect').value = savedTheme;
      applyTheme(savedTheme);

      // restore UI state
      restoreUIState();

      // initial nav based on hash
      const initial = location.hash ? location.hash.slice(1) : 'dashboard';
      navigate(initial, false);
      renderAll();
    }

    /* -------------------------
       Login click handler for auth panel
       ------------------------- */
    async function onLoginClick(){
      if(AUTH.isAdmin()){
        AUTH.logoutSession();
        showToast('Logged out','success');
        renderAll();
      }else{
        const ok = await AUTH.ensureAdmin();
        if(ok) renderAll();
      }
    }

    /* =========================
       Small helper utilities & expose API
       ========================= */
    function escapeHtmlForAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    const api = {
      getDB: ()=>deepCopy(currentDB),
      saveDB: ()=>{ saveDB(currentDB); showToast('DB saved','success'); },
      loadDB: ()=>{ currentDB = loadDB(); renderAll(); showToast('DB loaded','success'); },
      importFromJSON: (json)=>{ currentDB = json; saveDB(currentDB); renderAll(); },
      AUTH, SITEMAP, META
    };

    // wire import file input outside of control (global)
    document.getElementById('importFile').addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) importDBFromFile(e.target.files[0]); e.target.value=''; });

    // expose global
    window.SITEMAP_APP = api;

    // init after microtask to allow DOM ready
    setTimeout(init, 60);

    return api;
  })();

  /* =========================
     Utility functions shared by both modules
     ========================= */

  // Basic escape helpers used in inline event contexts
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  function sanitizeUrl(u){ if(!u) return ''; try{ const s = String(u).trim(); if(s.startsWith('data:')) return s; const url = new URL(s, location.origin); return url.toString(); }catch(e){ return String(u); } }
  function bytesToHex(bytes){ return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function hexToBytes(hex){ const len = hex.length/2; const out = new Uint8Array(len); for(let i=0;i<len;i++) out[i]=parseInt(hex.substr(i*2,2),16); return out; }

})(window, document);
</script>
</body>
</html>